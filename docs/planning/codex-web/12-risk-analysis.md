# 风险分析与应对

**文档版本**: v1.0  
**最后更新**: 2025-09-11  
**依赖文档**: [02-architecture.md](02-architecture.md), [11-implementation-roadmap.md](11-implementation-roadmap.md)

## 技术风险

## Web 特性 Top3 不确定性与最小实验（MVP 验证）

### A. 所见即所得的最终一致性（预览 diff ≡ 实际落盘）
**风险描述**：用户在 Web 端看到的多文件 diff 与最终 `apply_patch` 写盘结果不一致，可能源于预览与应用之间目标目录变化、补丁偏移/漂移、换行/编码差异、二进制文件替换、Git 状态差异（工作区 vs 暂存 vs HEAD）。

**影响**：破坏“可视治理”的信任，导致误改、脏状态与回退困难。

**缓解策略（方案）**：
- 计划对象（Plan）携带清单与基线：`{path, action, old_sha256, new_sha256, is_binary}`；应用前做“基线再校验”。
- 预览不依赖历史 patch，而是在“应用前”以临时渲染产物对“当前目标目录”重新 `git diff --no-index` 生成最终补丁，确保 WYSIWYG。
- 失配检测：若 `old_sha256 != current_sha256`，标记 STALE，提供三选：刷新预览、尝试三方合并（仅文本）、放弃本次应用。
- 原子应用：以 repo 级锁保护一次应用；优先新分支落盘；失败不留脏状态。
- 文本规范化：统一 LF 策略与编码（在临时区进行），避免 CRLF/编码引入的伪差异。

**最小实验（POC）**：
- 样例场景：
  1) 预览后第三方修改同一文件（插入/删除/重命名）
  2) 大文件与二进制替换
  3) CRLF→LF 差异
- 断言：
  - 预应用再校验能检测到 STALE 并阻断直接写盘
  - 重新计算的 diff 与应用结果一致；失败时无脏状态
  - 二进制替换需要显式额外确认
- 成功标准：
  - 3 类场景均能稳定进入“刷新或合并”分支
  - 预览与落盘后的 `git diff` 为空（完全一致）
  - 应用失败率 < 1%，失败零脏写

### B. 事件流的有序性、可恢复性与聚合正确性
**风险描述**：将 `codex-core` 事件（流式输出、工具事件、错误/重试）投递到 Web 层时出现乱序、丢失、重复；断线重连后状态错乱；UI 聚合出错误的“最终结果/补丁”。

**影响**：进度与结果误判，干预/审批无法可信进行。

**缓解策略（方案）**：
- 单会话单调序号：事件携带 `(session_id, offset)`，服务端环形缓冲，客户端带 `last_event_id` 恢复。
- 传输多路复用：WS 首帧声明会话与起始 offset；SSE 走 `Last-Event-ID`。
- 去重与重排：UI 聚合按 offset 去重；乱序缓存等待窗口内齐全后提交到可视层。
- 聚合器一致性：在服务端提供“事件归并器”参考实现，导出 `{status, text?, patch?}`，保证 CLI/TUI/Web 语义一致。
- 背压与限流：大日志时按块发送、截断提示与“展开更多”拉取。

**最小实验（POC）**：
- 构造 3 份离线事件样本（正常/无补丁/被拒）+ 扰动版（插入/重排/重复），验证聚合输出不变。
- 断线重连：在不同 offset 重连，确保不丢不重（最终状态一致）。
- 压测：高频 stdout/stderr 下 UI 无明显掉帧，事件延迟 < 200ms（95P）。

**成功标准**：
- 所有样本在扰动前后归并结果一致
- 重连后 UI 状态与最终报告一致；无“跳步/回退”现象
- 事件内存占用可控（滑窗/限深），无 OOM 风险

### C. 审批与安全边界的一致性（Web ≡ TUI/CLI）
**风险描述**：Web 接入后，敏感操作（`apply_patch`/`shell`/`mcp`）的审批、沙箱、日志脱敏与访问控制若与 TUI/CLI 不一致，可能绕过关口或暴露敏感信息；本地 Web 服务的 token/CSRF 保护不到位。

**影响**：安全事件、越权修改、敏感信息泄露。

**缓解策略（方案）**：
- 本地限定：仅 `127.0.0.1` 监听；一次性短期 token；严格 Origin/Referer 校验；默认禁用 CORS；X-Frame-Options/CSP 收紧。
- 审批一致：所有敏感步骤复用既有审批管道与策略；在 UI 以“审批卡片”展示上下文与影响范围；审批记录入审计日志。
- 策略预检：在计划阶段对步骤做策略 linter（危险命令、敏感路径、外网访问尝试）并标黄/阻断。
- 日志脱敏：对环境变量、秘钥、令牌做输出掩码；下载产物前提示敏感性。
- 不修改 `CODEX_SANDBOX_*` 逻辑，只做 UI/服务端集成与提示。

**最小实验（POC）**：
- 5 类敏感动作样例（文件越权写入、删除、外网访问、apply 大范围变更、mcp 外部调用），逐一验证审批拦截与审计。
- CSRF/Token：跨源请求被拒，令牌过期后需刷新；同源内多标签页共享会话但各自授权。
- 脱敏验证：环境变量/秘钥在日志与产物中被正确掩码。

**成功标准**：
- 审批路径与 CLI/TUI 等价；无绕过路径
- 所有敏感样例在无审批时被阻断；在有审批时全链路可追溯
- 基本安全基线（本地监听/CSRF/令牌）通过自测与脚本化回归

### 高风险项

#### R1: WebSocket 兼容性问题
**风险描述**: 企业网络环境或代理可能阻止 WebSocket 连接
- **影响**: 核心实时功能无法使用
- **概率**: 中等 (30%)
- **影响程度**: 高

**缓解策略**:
- 实现 SSE (Server-Sent Events) 备选方案
- 自动检测和切换机制
- 提供网络诊断工具

**应急预案**:
- 快速切换到 HTTP 长轮询模式
- 提供离线模式基础功能

#### R2: 现有系统破坏
**风险描述**: Web 端实现可能影响现有 TUI 功能
- **影响**: 现有用户工作流中断
- **概率**: 低 (15%)  
- **影响程度**: 极高

**缓解策略**:
- 严格的集成测试覆盖
- 渐进式部署和回滚机制
- 独立的配置和状态管理
- 充分的向后兼容性测试

**应急预案**:
- 快速禁用 Web 功能的开关
- 完整的配置备份和恢复流程

### 中风险项

#### R3: 性能瓶颈
**风险描述**: 并发连接和事件处理可能造成性能问题
- **影响**: 用户体验下降，资源消耗过高
- **概率**: 中等 (40%)
- **影响程度**: 中等

**缓解策略**:
- 连接池和资源限制
- 异步事件处理和缓存
- 性能监控和告警
- 分阶段压力测试

#### R4: 类型同步问题  
**风险描述**: Rust 和 TypeScript 类型定义可能不同步
- **影响**: 运行时错误，数据不一致
- **概率**: 中等 (35%)
- **影响程度**: 中等

**缓解策略**:
- 自动化类型生成流程
- CI/CD 中的类型一致性检查
- 运行时类型验证
- 详细的接口契约测试

## 安全风险

### 高风险项

#### R5: 本地权限提升
**风险描述**: 恶意代码可能利用 Web 服务获取更多权限
- **影响**: 系统安全受损
- **概率**: 低 (10%)
- **影响程度**: 极高

**缓解策略**:
- 严格的沙箱策略遵守
- 输入验证和输出过滤
- 最小权限原则
- 定期安全审计

#### R6: 访问令牌泄露
**风险描述**: 访问令牌可能被恶意获取或滥用
- **影响**: 未授权访问
- **概率**: 中等 (25%)
- **影响程度**: 高

**缓解策略**:
- 令牌短期有效性
- 基于 IP 的访问限制
- 异常访问检测
- 会话超时机制

### 中风险项

#### R7: 数据泄露风险
**风险描述**: 敏感代码或配置可能通过 Web 接口暴露
- **影响**: 知识产权或隐私泄露
- **概率**: 低 (20%)
- **影响程度**: 中等

**缓解策略**:
- 敏感信息过滤和脱敏
- 完整的访问日志
- 数据传输加密
- 定期安全扫描

## 业务风险

### 中风险项

#### R8: 开发资源不足
**风险描述**: 项目复杂度超预期，开发资源紧张
- **影响**: 项目延期，功能缩减
- **概率**: 中等 (45%)
- **影响程度**: 中等

**缓解策略**:
- MVP 优先，功能分阶段交付
- 并行开发，前后端解耦
- 代码复用最大化
- 外部资源支持

#### R9: 用户接受度问题
**风险描述**: 用户可能不适应 Web 界面操作
- **影响**: 产品采用率低
- **概率**: 中等 (30%)
- **影响程度**: 中等

**缓解策略**:
- 早期用户反馈收集
- 详细的用户体验设计
- 平滑的迁移指导
- TUI 和 Web 端并存策略

### 低风险项

#### R10: 第三方依赖风险
**风险描述**: 关键依赖库更新或废弃可能影响功能
- **影响**: 维护成本增加
- **概率**: 低 (25%)
- **影响程度**: 低

**缓解策略**:
- 选择成熟稳定的依赖
- 定期依赖更新和安全扫描
- 关键功能的备选实现方案

## 运维风险

### 中风险项

#### R11: 部署复杂性
**风险描述**: Web 端增加了部署和配置的复杂性
- **影响**: 运维成本增加，故障概率提高
- **概率**: 中等 (35%)
- **影响程度**: 中等

**缓解策略**:
- 简化的部署脚本和文档
- 容器化部署选项
- 健康检查和自动恢复
- 详细的故障排查指南

#### R12: 监控盲点
**风险描述**: 新增的 Web 服务可能存在监控盲点
- **影响**: 问题发现滞后
- **概率**: 中等 (30%)
- **影响程度**: 中等

**缓解策略**:
- 完整的日志体系
- 关键指标监控
- 自动化告警机制
- 定期监控效果评估

## 风险监控策略

### 实时监控指标

#### 技术指标
```rust
struct RiskMonitoringMetrics {
    // 性能风险指标
    avg_response_time_ms: f64,
    websocket_connection_failures: u64,
    memory_usage_mb: u64,
    cpu_usage_percent: f64,
    
    // 安全风险指标
    failed_auth_attempts: u64,
    suspicious_requests: u64,
    rate_limit_violations: u64,
    
    // 稳定性指标
    error_rate_percent: f64,
    session_timeout_count: u64,
    service_restart_count: u64,
}
```

#### 告警阈值设置
- **响应时间** > 500ms (警告), > 1000ms (严重)
- **错误率** > 1% (警告), > 5% (严重)  
- **内存使用** > 80% 配额 (警告), > 95% (严重)
- **连接失败率** > 10% (警告), > 25% (严重)

### 风险评估流程

#### 定期评估 (每周)
1. 收集监控数据和用户反馈
2. 评估现有风险项的状态变化
3. 识别新的潜在风险
4. 调整缓解策略的优先级

#### 应急响应 (即时)
1. 自动告警触发应急预案
2. 快速问题诊断和定位
3. 执行预定的缓解措施
4. 事后分析和改进措施

## 风险应对预案

### 服务中断应对
```bash
# 快速服务重启
#!/bin/bash
echo "检测到服务异常，开始应急重启..."

# 保存当前状态
ps aux | grep codex-web > /tmp/codex-web-state.log

# 尝试优雅关闭
pkill -TERM codex-web
sleep 5

# 强制终止（如果需要）
pkill -KILL codex-web

# 重启服务
cd /path/to/codex
./target/release/codex web --port 8080 &

echo "服务重启完成，PID: $!"
```

### 数据恢复流程
```rust
async fn emergency_data_recovery() -> Result<(), RecoveryError> {
    // 1. 停止新的请求处理
    server.stop_accepting_new_connections().await;
    
    // 2. 保存当前会话状态
    let sessions = session_registry.export_all_sessions().await;
    save_to_emergency_backup(&sessions)?;
    
    // 3. 清理损坏的状态
    session_registry.clear_corrupted_sessions().await;
    
    // 4. 从备份恢复关键数据
    let recovered_sessions = load_from_backup()?;
    session_registry.restore_sessions(recovered_sessions).await;
    
    // 5. 重新开始接受连接
    server.resume_accepting_connections().await;
    
    Ok(())
}
```

### 安全事件响应
```rust
enum SecurityIncidentLevel {
    Low,    // 记录日志
    Medium, // 限制访问
    High,   // 暂停服务
    Critical, // 立即关闭
}

async fn handle_security_incident(
    incident: SecurityIncident,
) -> Result<(), SecurityError> {
    match incident.level {
        SecurityIncidentLevel::Low => {
            log_security_event(&incident);
        }
        SecurityIncidentLevel::Medium => {
            ban_suspicious_ips(&incident.source_ips).await;
            increase_auth_requirements().await;
        }
        SecurityIncidentLevel::High => {
            suspend_new_connections().await;
            notify_security_team(&incident);
        }
        SecurityIncidentLevel::Critical => {
            emergency_shutdown().await;
            notify_security_team_urgent(&incident);
        }
    }
    Ok(())
}
```

## 持续改进

### 风险管理成熟度评估
1. **识别能力**: 是否能及时发现新风险
2. **评估准确性**: 风险评估与实际情况的匹配度
3. **响应效率**: 风险应对措施的执行速度
4. **预防效果**: 预防性措施的有效性

### 经验教训总结
- 建立风险事件知识库
- 定期复盘和案例分析
- 跨团队经验分享
- 外部安全咨询和审计

---
**变更记录**：
- v1.0 (2025-09-11): 初始版本，全面的风险分析和应对策略
