# 测试与验收计划

单元测试（前端共享库）
- 发现与覆盖：多层 `.codex/modes` + `$CODEX_HOME/modes` 合并与覆盖；非法 ID 跳过。
- Frontmatter：重复变量/空枚举/非法正则；类型推断；默认值与必填交互。
- 解析/渲染：shortcuts 与位置参数；布尔/数值/枚举/正则校验；启用顺序稳定；无常驻省略 `<mode_instructions>`；模板正常/异常路径。
- 等价检测：同串不发送；不同串发送。

集成（TUI）
- TUI：摘要/详情/错误快照；键位导航；去抖仅覆写一次；关闭模式清除 `mode_scoped` 缓存；预览/渲染视图一致。

手动验收
- 默认无模式：仅基线。
- 启用单模式：`<mode_instructions>` 含一段，顺序正确。
- 多模式顺序：A→B 启用为 A,B；关闭 A 再启用为 B,A。
- 必填缺失：UI `⚠`，不发送；补齐后发送并更新。
- 覆盖优先级：全局与项目同名，项目生效；Slash 标注来源。
- 去抖：快速多次编辑仅一次有效覆写。

快照稳定性检查
- 渲染前后统一换行、空白与块间空行（见 rendering.md 的规范化步骤）。
- 变量序列化顺序与格式稳定（`key=value`，逗号+空格）。
- TUI 快照：
  - 折叠（摘要）/展开（详情）/错误态（⚠）/就地编辑/表单编辑 5 组快照。
  - 列表顺序按启用时间稳定，变量顺序按声明顺序稳定。

（无 CLI）

---

最小差异守护用例（新增）
- 非 `tui/src/modes/**` 的快照不可变化（CI 断言）；
- `app_event.rs` 与 `app.rs` 的新增枚举/分支 ≤ 1（若保留仅 `OpenModeBar`）；
- Host 插桩统计 ≤ 60 行（以 `git diff --stat` 记录）；
- 仓库根不得包含 `.codex/modes/**` 与 `.codex/prompts/**`；
- 依赖隔离：`codex-modes` 的三方依赖仅在其 `Cargo.toml` 中声明，根 workspace 不新增 indexmap/regex/serde_yaml 等；
- 未启用模式时 `<user_instructions>` 与上游等价（哈希一致）；
- 自动启用仅在满足“非恢复会话且所有必填变量可由默认值满足”的条件，且不产生冗余历史消息。
